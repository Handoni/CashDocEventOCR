<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>OCR 비교 뷰어 (3‑Way)</title>
        <style>
        .images-container { display:flex; gap:20px; }
        .image-section    { flex:1 1 0; text-align:center; }
        .image-container  { position:relative; display:inline-block; }
        .image-container img{ display:block; max-width:100%; }
        .bbox             { position:absolute; border:2px solid red; cursor:pointer; }
        .caption          { position:absolute; background:rgba(0,0,0,.8); color:#fff;
                            padding:2px 5px; display:none; font-size:17px; white-space:pre-line; }
        .nav-wrapper      { display:flex; gap:30px; margin:25px 0; }
        .nav-btn          { padding:8px 18px; font-size:18px; border:none; border-radius:6px;
                            box-shadow:0 2px 4px rgba(0,0,0,.2); text-decoration:none; cursor:pointer; }
        .nav-btn:disabled { opacity:.4; cursor:default; }
    </style>
    </head>
    <body>

        <!-- 페이지 네비게이션 -->
        <div class="nav-wrapper">
            {% if prev_name %}<a href="/compare/{{ prev_name }}"
                class="nav-btn">이전</a>{% endif %}
            {% if next_name %}<a href="/compare/{{ next_name }}"
                class="nav-btn">다음</a>{% endif %}
        </div>

        <div class="images-container">
            <!-- Upstage (픽셀 좌표) -->
            <div class="image-section">
                <h2>Document-OCR</h2>
                <div class="image-container">
                    <img id="upstage-img" src="{{ upstage.image_url }}"
                        alt="Upstage 이미지">
                    {% for ann in upstage.annotations %}
                    <div class="bbox upstage-bbox"
                        data-x="{{ ann.left }}" data-y="{{ ann.top }}"
                        data-w="{{ ann.width }}" data-h="{{ ann.height }}"
                        onclick='showCombinedCaption(event, {{ ann.text|tojson}}, "caption-upstage")'>
                    </div>
                    {% endfor %}
                    <div id="caption-upstage" class="caption"></div>
                </div>
            </div>

            
            <!-- Upstage‑DOC (% 좌표) -->
            <div class="image-section">
                <h2>Document-Parsing</h2>
                <div class="image-container">
                    <img id="doc-img" src="{{ upstage_doc.image_url }}"
                        alt="Upstage‑DOC 이미지">
                    {% for ann in upstage_doc.annotations %}
                    <div class="bbox doc-bbox"
                        data-x="{{ ann.left_pct }}" data-y="{{ ann.top_pct }}"
                        data-w="{{ ann.width_pct }}"
                        data-h="{{ ann.height_pct }}"
                        data-unit="pct"
                        onclick='showCombinedCaption(event, {{ ann.text|tojson}}, "caption-doc")'>
                    </div>
                    {% endfor %}
                    <div id="caption-doc" class="caption"></div>
                </div>
            </div>


        </div>

        <script>
        /* 공통 BBox 배치 함수 */
        function placeBBoxes(img, selector){
            const scaleXpx = img.clientWidth  / img.naturalWidth;
            const scaleYpx = img.clientHeight / img.naturalHeight;
            const imgW = img.clientWidth, imgH = img.clientHeight;

            document.querySelectorAll(selector).forEach(box=>{
                const unit = box.dataset.unit;        // 'pct' | undefined
                const x = parseFloat(box.dataset.x);
                const y = parseFloat(box.dataset.y);
                const w = parseFloat(box.dataset.w);
                const h = parseFloat(box.dataset.h);

                const left   = unit==='pct' ? x*imgW/100 : x*scaleXpx;
                const top    = unit==='pct' ? y*imgH/100 : y*scaleYpx;
                const width  = unit==='pct' ? w*imgW/100 : w*scaleXpx;
                const height = unit==='pct' ? h*imgH/100 : h*scaleYpx;

                Object.assign(box.style,{
                    left:`${left}px`, top:`${top}px`,
                    width:`${width}px`, height:`${height}px`
                });
            });
        }

        /* 초기·리사이즈 시 BBox 재배치 */
        window.addEventListener('load', ()=>{
            const upImg  = document.getElementById('upstage-img');
            const docImg = document.getElementById('doc-img');

            const refresh = ()=>{
                placeBBoxes(upImg , '.upstage-bbox');
                placeBBoxes(docImg, '.doc-bbox');
            };
            refresh();
            window.addEventListener('resize', refresh);
        });

        function showCombinedCaption(event, text, captionId) {
            const captionDiv = document.getElementById(captionId);
            captionDiv.style.display = "block";
            captionDiv.innerText = `원본: ${text}
번역 중...`;
            captionDiv.style.left = event.target.style.left;
            captionDiv.style.top  = (parseInt(event.target.style.top) + parseInt(event.target.style.height) + 5) + "px";
            event.stopPropagation();

            fetch('/translate?text=' + encodeURIComponent(text))
                .then(res => res.json())
                .then(data => {
                    captionDiv.innerText = `원본: ${text}
영어: ${data.translated}`;
                })
                .catch(err => {
                    console.error('번역 에러:', err);
                    captionDiv.innerText = `원본: ${text}
번역 실패`;
                });
        };
</script>
    </body>
</html>
