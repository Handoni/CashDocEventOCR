<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>ocr compare</title>
    <style>
        .images-container {
            display: flex;
            gap: 20px;
        }
        .image-section {
            text-align: center;
        }
        .image-container {
            position: relative;
            display: inline-block;
        }
        .image-container img {
            display: block;
            max-width: 100%;
        }
        .bbox {
            position: absolute;
            border: 2px solid red;
            cursor: pointer;
        }
        .caption {
            position: absolute;
            background-color: rgba(0,0,0,0.7);
            color: #fff;
            padding: 2px 5px;
            display: none;
            font-size: 14px;
            white-space: pre-line;
            cursor: default;
        }
        .nav-wrapper {
            display: flex;
            justify-content: left;
            gap: 30px;
            margin: 25px 0;
        }
        .nav-btn {
            padding: 8px 18px;
            font-size: 30px;
            border: 1px solid #ccc;
            border-radius: 6px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            cursor: pointer;
            text-decoration: none;
            color: #000;
        }
        .nav-btn:disabled {
            opacity: 0.4;
            cursor: default;
        }
    </style>
</head>
<body>

    <div class="nav-wrapper">
        {% if prev_name %}
        <a href="/compare/{{ prev_name }}" class="nav-btn">이전</a>
        {% endif %}
        {% if next_name %}
        <a href="/compare/{{ next_name }}" class="nav-btn">다음</a>
        {% endif %}
    </div>

    <div class="images-container">
        <!-- Upstage 영역 -->
        <div class="image-section">
            <h2>Upstage</h2>
            <div class="image-container">
                <img id="upstage-img" src="{{ upstage.image_url }}" alt="Upstage 이미지">
                {% for ann in upstage.annotations %}
                <div class="bbox upstage-bbox"
                     data-left="{{ ann.left }}" data-top="{{ ann.top }}"
                     data-width="{{ ann.width }}" data-height="{{ ann.height }}"
                     onclick='showCombinedCaption(event, {{ ann.text|tojson }}, "caption-upstage")'></div>
                {% endfor %}
                <div id="caption-upstage" class="caption"></div>
            </div>
        </div>

        <!-- Naver 영역 -->
        <div class="image-section">
            <h2>Naver</h2>
            <div class="image-container">
                <img id="naver-img" src="{{ naver.image_url }}" alt="Naver 이미지">
                {% for ann in naver.annotations %}
                <div class="bbox naver-bbox"
                     data-left="{{ ann.left }}" data-top="{{ ann.top }}"
                     data-width="{{ ann.width }}" data-height="{{ ann.height }}"
                     onclick='showCombinedCaption(event, {{ ann.text|tojson }}, "caption-naver")'></div>
                {% endfor %}
                <div id="caption-naver" class="caption"></div>
            </div>
        </div>
    </div>

    <script>
        /**
         * 주어진 이미지 요소의 표시 크기에 맞추어 bbox overlay 위치/크기를 재계산
         * @param {HTMLImageElement} imgElem 대상 이미지 요소
         * @param {string} selector   bbox 선택자 (예: '.upstage-bbox')
         */
        function adjustBBoxes(imgElem, selector) {
            if (!imgElem.complete) return; // 이미지 아직 로드 전이면 패스
            const scaleX = imgElem.clientWidth / imgElem.naturalWidth;
            const scaleY = imgElem.clientHeight / imgElem.naturalHeight;
            document.querySelectorAll(selector).forEach(box => {
                const left   = parseFloat(box.dataset.left)   * scaleX;
                const top    = parseFloat(box.dataset.top)    * scaleY;
                const width  = parseFloat(box.dataset.width)  * scaleX;
                const height = parseFloat(box.dataset.height) * scaleY;
                box.style.left   = left + 'px';
                box.style.top    = top  + 'px';
                box.style.width  = width  + 'px';
                box.style.height = height + 'px';
            });
        }

        // 초기 세팅 및 창 크기 변경 대응
        window.addEventListener('load', () => {
            const upImg   = document.getElementById('upstage-img');
            const naverImg = document.getElementById('naver-img');
            const refresh = () => {
                adjustBBoxes(upImg,   '.upstage-bbox');
                adjustBBoxes(naverImg, '.naver-bbox');
            };
            refresh();
            window.addEventListener('resize', refresh);
        });

        function showCombinedCaption(event, text, captionId) {
            const captionDiv = document.getElementById(captionId);
            captionDiv.style.display = "block";
            captionDiv.innerText = `원본: ${text}
번역 중...`;
            captionDiv.style.left = event.target.style.left;
            captionDiv.style.top  = (parseInt(event.target.style.top) + parseInt(event.target.style.height) + 5) + "px";
            event.stopPropagation();

            fetch('/translate?text=' + encodeURIComponent(text))
                .then(res => res.json())
                .then(data => {
                    captionDiv.innerText = `원본: ${text}
영어: ${data.translated}`;
                })
                .catch(err => {
                    console.error('번역 에러:', err);
                    captionDiv.innerText = `원본: ${text}
번역 실패`;
                });
        }
</script>
</body>
</html>
